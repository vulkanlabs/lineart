# .github/workflows/docker-build.yml

name: Build and Push Docker Images to GHCR

on:
  workflow_call:
    inputs:
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      postgres_version:
        description: 'Postgres version to use'
        required: false
        default: '16.3'
        type: string
      force_publish:
        description: 'Force publish images'
        required: false
        default: false
        type: boolean
      use_pypi:
        description: 'Use PyPI packages instead of local copy'
        required: false
        default: false
        type: boolean
      vulkan_version:
        description: 'Version of vulkan to install from PyPI'
        required: false
        type: string
        default: ''
      vulkan_engine_version:
        description: 'Version of vulkan-engine to install from PyPI'
        required: false
        type: string
        default: ''

jobs:
  build_and_push_images:
    runs-on: ubuntu-latest
    # Grant GITHUB_TOKEN permissions to write to GitHub Packages (GHCR)
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false # Ensures that if one matrix job fails, others will continue
      matrix:
        image:
          - name: app
            dockerfile: ./images/vulkan-server-app/Dockerfile
            context: . 
            build_args: | 
              PYTHON_VERSION=${{ inputs.python_version }}
          - name: dagster 
            dockerfile: ./images/dagster.Dockerfile
            context: . 
            build_args: |
              PYTHON_VERSION=${{ inputs.python_version }}
              DAGSTER_HOME=/opt/dagster
              VULKAN_HOME=/opt/vulkan
              VULKAN_SERVER_PATH=/opt/server
              VULKAN_SCRIPTS_PATH=/opt/scripts
              DAGSTER_PORT=3000
              VULKAN_PORT=3001
          - name: dagster-db
            dockerfile: ./images/dagster-db/Dockerfile
            context: . 
            build_args: | 
              POSTGRES_VERSION=${{ inputs.postgres_version }}
          - name: vulkan-web-app
            dockerfile: ./images/vulkan-web-app.Dockerfile
            context: . 
            build_args: |
              PYTHON_VERSION=${{ inputs.python_version }}
              NEXT_PUBLIC_VULKAN_SERVER_URL=http://app:6001
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # This step checks out your repository under $GITHUB_WORKSPACE, so your workflow can access it.

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        # QEMU is useful for multi-platform builds.

      - name: Set up Docker Buildx
        id: buildx # Give the buildx setup step an id to reference its outputs
        uses: docker/setup-buildx-action@v3
        # Buildx is a Docker CLI plugin for advanced build capabilities.

      - name: Log in to GitHub Container Registry
        # This step logs in to GHCR. It only runs on pushes to 'main' or on tag pushes.
        # It does not run for pull requests or other branches to avoid publishing test images.
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # github.repository_owner is the organization or user that owns the repository.
          username: ${{ github.repository_owner }}
          # GITHUB_TOKEN is a special token provided by Actions that has permissions to push to GHCR for this repo.
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for PyPI package availability
        if: ${{ inputs.use_pypi }}
        run: |
          echo "Verifying PyPI packages are available..."

          # Function to check package availability with retry and exponential backoff
          check_package() {
            PACKAGE=$1
            VERSION=$2
            MAX_RETRIES=10
            RETRY_COUNT=0
            WAIT_TIME=5

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Checking for $PACKAGE==$VERSION..."

              if pip index versions --pre "$PACKAGE" 2>/dev/null | grep -q "$VERSION"; then
                echo "✓ Package $PACKAGE==$VERSION is available!"
                return 0
              fi

              if [ $RETRY_COUNT -eq $((MAX_RETRIES - 1)) ]; then
                echo "ERROR: Package $PACKAGE==$VERSION not available after $MAX_RETRIES retries"
                return 1
              fi

              echo "Package not yet available, waiting ${WAIT_TIME}s..."
              sleep $WAIT_TIME
              RETRY_COUNT=$((RETRY_COUNT + 1))
              WAIT_TIME=$((WAIT_TIME * 2))  # Exponential backoff: 5s, 10s, 20s, 40s...
            done
          }

          # Check vulkanlabs-vulkan package
          check_package "vulkanlabs-vulkan" "${{ inputs.vulkan_version }}" || exit 1

          # Check vulkanlabs-vulkan-engine package
          check_package "vulkanlabs-vulkan-engine" "${{ inputs.vulkan_engine_version }}" || exit 1

          echo "✓ All PyPI packages are available!"

      - name: Determine Image Tags
        id: meta 
        uses: docker/metadata-action@v5
        with:
          # A list of images to generate metadata for. We use the matrix image name.
          # The image name on GHCR will be ghcr.io/OWNER/IMAGE_NAME.
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}
          tags: |
            # Generates a 'latest' tag for pushes to the main branch.
            type=raw,value=latest,enable={{is_default_branch}}
            # Generates a tag based on the Git SHA (e.g., ghcr.io/owner/image:sha-7d6a5f0)
            type=sha
            # Generates a tag from the Git tag if this is a tag event (e.g., ghcr.io/owner/image:v1.0.0)
            type=ref,event=tag

      - name: Build and push Docker image for ${{ matrix.image.name }}
        id: build_and_push # Give this step an id
        uses: docker/build-push-action@v5
        if: ${{ matrix.image.name != 'vulkan-web-app' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')))  }}
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            ${{ matrix.image.build_args }}
            USE_PYPI=${{ inputs.use_pypi }}
            VULKAN_VERSION=${{ inputs.vulkan_version }}
            VULKAN_ENGINE_VERSION=${{ inputs.vulkan_engine_version }}
          push: true
          # Use the tags and labels generated by the metadata-action.
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Enable build cache for faster builds using GitHub cache.
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Use the buildx builder instance.
          builder: ${{ steps.buildx.outputs.name }}

      - name: Image digest
        # This step runs only if the image was pushed (i.e., not a pull request build).
        if: steps.build_and_push.outputs.digest && ((github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))) || github.event_name == 'workflow_dispatch')
        run: |
            echo "Image digest for ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}: ${{ steps.build_and_push.outputs.digest }}"

