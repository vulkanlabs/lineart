# .github/workflows/docker-build.yml

name: Build and Push Docker Images to GHCR

# Controls when the workflow will run
on:
  push:
    branches: [ "main", "build-docker-images" ] # Triggers the workflow on push events to the main branch
    tags: [ 'v*.*.*' ] # Triggers on version tags like v1.0.0
  pull_request:
    branches: [ "main" ] # Triggers the workflow on pull requests targeting the main branch (won't push)
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build_and_push_images:
    runs-on: ubuntu-latest # Use the latest Ubuntu runner
    # Grant GITHUB_TOKEN permissions to write to GitHub Packages (GHCR)
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false # Ensures that if one matrix job fails, others will continue
      matrix:
        image:
          - name: app # Corresponds to your 'app' service
            dockerfile: ./images/vulkan-server-app/Dockerfile
            context: . # Build context for 'app'
            build_args: | # Build arguments for 'app'
              PYTHON_VERSION=3.12
          - name: dagster # Corresponds to your 'dagster' service
            dockerfile: ./images/dagster.Dockerfile
            context: . # Build context for 'dagster'
            build_args: | # Build arguments for 'dagster'
              PYTHON_VERSION=3.12
              DAGSTER_HOME=/opt/dagster
              VULKAN_HOME=/opt/vulkan
              VULKAN_SERVER_PATH=/opt/server
              VULKAN_SCRIPTS_PATH=/opt/scripts
              DAGSTER_PORT=3000
              VULKAN_PORT=3001
          - name: dagster-db # Corresponds to your 'dagster-db' service
            dockerfile: ./images/dagster-db/Dockerfile
            context: . # Build context for 'dagster-db'
            build_args: | # Build arguments for 'dagster-db'
              POSTGRES_VERSION=16.3
          - name: upload-svc # Corresponds to your 'upload-svc' service
            dockerfile: ./images/upload-svc.Dockerfile
            context: . # Build context for 'upload-svc'
            build_args: | # Build arguments for 'upload-svc'
              PYTHON_VERSION=3.12
          # Note: 'app-db' from your docker-compose uses a pre-built image (postgres:16.3)
          # and is therefore not included in this build matrix, which is for building images from Dockerfiles.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # This step checks out your repository under $GITHUB_WORKSPACE, so your workflow can access it.

      - name: Set up Docker Buildx
        id: buildx # Give the buildx setup step an id to reference its outputs
        uses: docker/setup-buildx-action@v3
        # Buildx is a Docker CLI plugin for advanced build capabilities.

      - name: Log in to GitHub Container Registry
        # This step logs in to GHCR. It only runs on pushes to 'main' or on tag pushes.
        # It does not run for pull requests or other branches to avoid publishing test images.
        if: (github.event_name == 'push' && (github.ref == 'refs/heads/build-docker-images' || startsWith(github.ref, 'refs/tags/v'))) || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # github.repository_owner is the organization or user that owns the repository.
          username: ${{ github.repository_owner }}
          # GITHUB_TOKEN is a special token provided by Actions that has permissions to push to GHCR for this repo.
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Image Tags
        id: meta # Give this step an id to reference its outputs
        # This action helps generate metadata (tags, labels) for your Docker images.
        uses: docker/metadata-action@v5
        with:
          # A list of images to generate metadata for. We use the matrix image name.
          # The image name on GHCR will be ghcr.io/OWNER/IMAGE_NAME.
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}
          tags: |
            # Generates a 'latest' tag for pushes to the main branch.
            type=raw,value=latest,enable={{is_default_branch}}
            # Generates a tag based on the Git SHA (e.g., ghcr.io/owner/image:sha-7d6a5f0)
            type=sha
            # Generates a tag from the Git tag if this is a tag event (e.g., ghcr.io/owner/image:v1.0.0)
            type=ref,event=tag

      - name: Build and push Docker image for ${{ matrix.image.name }}
        id: build_and_push # Give this step an id
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          build-args: ${{ matrix.image.build_args }}
          # Push the image only if the event is a push to 'main', a tag push, or a manual dispatch.
          # This prevents pushing on pull request builds.
          push: ${{ (github.event_name == 'push' && (github.ref == 'refs/heads/build-docker-images' || startsWith(github.ref, 'refs/tags/v'))) || github.event_name == 'workflow_dispatch' }}
          # Use the tags generated by the metadata-action.
          tags: ${{ steps.meta.outputs.tags }}
          # Use the labels generated by the metadata-action (includes things like git SHA, repo URL).
          labels: ${{ steps.meta.outputs.labels }}
          # Enable build cache for faster builds using GitHub cache.
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Use the buildx builder instance.
          builder: ${{ steps.buildx.outputs.name }}

      - name: Image digest
        # This step runs only if the image was pushed (i.e., not a pull request build).
        if: steps.build_and_push.outputs.digest && ((github.event_name == 'push' && (github.ref == 'refs/heads/build-docker-images' || startsWith(github.ref, 'refs/tags/v'))) || github.event_name == 'workflow_dispatch')
        run: |
            echo "Image digest for ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}: ${{ steps.build_and_push.outputs.digest }}"

