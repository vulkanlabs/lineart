name: Build Python SDK (Speakeasy)

on:
  push:
    # Use ** so branches with slashes (feature/x) are included.
    branches: ["**"]
  workflow_dispatch:
    inputs:
      force:
        description: Force regeneration of the SDK (bypass cache)
        type: boolean
        default: false
      set_version:
        description: Optionally set a specific SDK version (e.g. 0.3.0)
        type: string
        required: false
      runner:
        description: Runner to use (override default ubuntu-latest)
        type: string
        default: ubuntu-latest
      mode:
        description: Speakeasy generation mode (e.g. pr, direct, test)
        type: string
        default: test

permissions:
  contents: read
  packages: write
  # allow PR creation to downstream repo if action does that
  pull-requests: write

jobs:
  build_and_generate_python_sdk:
    name: Generate OpenAPI + Python SDK
    # NOTE: Linter flagged dynamic expression form; using static runner. Change manually if custom runner needed.
    runs-on: ubuntu-latest
    env:
      OPENAPI_SPEC_PATH: generated/openapi.json
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install uv & sync deps
        run: |
          set -euxo pipefail
          pip install 'uv<0.8'
          uv sync

      - name: Generate OpenAPI spec
        run: |
            set -euxo pipefail
            mkdir -p generated
            uv run python scripts/export-openapi.py --out "$OPENAPI_SPEC_PATH"
            test -s "$OPENAPI_SPEC_PATH"

      - name: Upload spec artifact (debug/traceability)
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: ${{ env.OPENAPI_SPEC_PATH }}
          if-no-files-found: error

      - name: Verify spec exists before SDK generation
        run: |
          set -euxo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -al . || true
          ls -al generated || true
          test -f "$OPENAPI_SPEC_PATH" || { echo "Spec missing before Speakeasy step" >&2; exit 1; }
          echo "Spec size:" $(wc -c < "$OPENAPI_SPEC_PATH")
          
          # Copy spec to root as openapi.json for easier path resolution
          cp "$OPENAPI_SPEC_PATH" openapi.json
          echo "Copied spec to root: $(wc -c < openapi.json) bytes"

      - name: Generate SDK (Python)
        uses: speakeasy-api/sdk-generation-action@v15
        with:
          force: ${{ github.event.inputs.force }}
          set_version: ${{ github.event.inputs.set_version }}
          mode: ${{ github.event.inputs.mode }}
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}
