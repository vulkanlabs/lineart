FROM python:{{ python_version }}-slim

RUN pip install uv
RUN mkdir /opt/dependencies

COPY vulkan /opt/dependencies/vulkan
COPY vulkan-public /opt/dependencies/vulkan-public

{% if dependencies|length > 0 %}
COPY {% for dependency in dependencies -%}
{{ dependency.name }} \
    {% endfor -%}
/opt/dependencies/
{% endif %}

COPY {{ policy.name }} /opt/policy/
RUN uv pip install --system --no-cache /opt/dependencies/vulkan-public /opt/dependencies/vulkan \ 
    /opt/policy {% if dependencies|length > 0 %} \ {% endif %}
{%- for dependency in dependencies -%}
/opt/dependencies/{{ dependency.name }} {% if not loop.last %} {% endif %}
{%- endfor %}

# Install Apache Beam SDK.
RUN uv pip install --system --no-cache apache-beam[gcp]==2.60.0
RUN pip check

# Copy files from official SDK image, including script/dependencies.
COPY --from=apache/beam_python{{ python_version }}_sdk:2.60.0 /opt/apache/beam /opt/apache/beam

# Set the entrypoint to Apache Beam SDK launcher.
ENTRYPOINT ["/opt/apache/beam/boot"]