tests git:(feat/async-vulkan-engine) ✗ uv run pytest test_integration_*.py -v
warning: The `tool.uv.dev-dependencies` field (used in `/home/dev/work/fusion/lineart-plus/lineart/pyproject.toml`, `/home/dev/work/fusion/lineart-plus/lineart/vulkan-server/pyproject.toml`, `/home/dev/work/fusion/lineart-plus/lineart/vulkan/pyproject.toml`, `/home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/pyproject.toml`) is deprecated and will be removed in a future release; use `dependency-groups.dev` instead
================================================= test session starts ==================================================
platform linux -- Python 3.12.12, pytest-9.0.1, pluggy-1.6.0 -- /home/dev/work/fusion/lineart-plus/lineart/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=session, asyncio_default_test_loop_scope=function
collected 23 items

test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_create_data_source PASSED        [  4%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_get_data_source PASSED           [  8%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_get_data_source_not_found PASSED [ 13%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_update_data_source PASSED        [ 17%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_list_data_sources PASSED         [ 21%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_archive_data_source PASSED       [ 26%]
test_integration_data_source_service.py::TestDataSourceServiceIntegration::test_delete_data_source PASSED        [ 30%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_create_policy PASSED                      [ 34%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_get_policy PASSED                         [ 39%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_get_policy_not_found PASSED               [ 43%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_update_policy PASSED                      [ 47%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_list_policies PASSED                      [ 52%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_list_policies_excludes_archived PASSED    [ 56%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_archive_policy PASSED                     [ 60%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_delete_policy_without_versions PASSED     [ 65%]
test_integration_policy_service.py::TestPolicyServiceIntegration::test_delete_policy_with_versions_raises_exception PASSED [ 69%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_create_policy_version PASSED [ 73%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_get_policy_version PASSED  [ 78%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_get_policy_version_not_found PASSED [ 82%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_update_policy_version FAILED [ 86%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_list_policy_versions PASSED [ 91%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_archive_policy_version PASSED [ 95%]
test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_delete_policy_version PASSED [100%]

======================================================= FAILURES =======================================================
____________________________ TestPolicyVersionServiceIntegration.test_update_policy_version ____________________________

self = <tests.test_integration_policy_version_service.TestPolicyVersionServiceIntegration object at 0x7f32b66de750>
policy_version_service = <vulkan_engine.services.policy_version.PolicyVersionService object at 0x7f32b487a810>
policy_service = <vulkan_engine.services.policy.PolicyService object at 0x7f32b488c740>
sample_project_id = 'ed75719d-79fd-4a39-825c-6c339d40ed61'

    async def test_update_policy_version(
        self,
        policy_version_service: PolicyVersionService,
        policy_service: PolicyService,
        sample_project_id: str,
    ):
        """Test updating a policy version."""
        sample_policy = await self._create_sample_policy(policy_service, sample_project_id)

        # Create a version
        version_data = PolicyVersionBase(
            policy_id=sample_policy,
            alias="v1.0",
        )
        created_version = await policy_version_service.create_policy_version(
            version_data, project_id=sample_project_id
        )

        # Update it
        update_data = PolicyVersionUpdate(
            alias="v1.1",
            workflow=WorkflowBase(
                spec={"nodes": [], "input_schema": {"cpf": "str", "name": "str"}},
                requirements=[],
            ),
        )
>       updated_version = await policy_version_service.update_policy_version(
            created_version.policy_version_id, update_data, project_id=sample_project_id
        )

test_integration_policy_version_service.py:157:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../vulkan_engine/services/policy_version.py:208: in update_policy_version
    return schemas.PolicyVersion.from_orm(version, workflow)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../vulkan_engine/schemas.py:135: in from_orm
    last_updated_at=policy_version.last_updated_at,
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:569: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1096: in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1126: in _fire_loader_callables
    return state._load_expired(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py:803: in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:1674: in load_scalar_attributes
    result = load_on_ident(
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:510: in load_on_ident
    return load_on_pk_identity(
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:695: in load_on_pk_identity
    session.execute(
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../../.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../../.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../../.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../../.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:585: in execute
    self._adapt_connection.await_(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

awaitable = <coroutine object AsyncAdapt_asyncpg_cursor._prepare_and_execute at 0x7f32b686b4c0>

    def await_only(awaitable: Awaitable[_T]) -> _T:
        """Awaits an async function in a sync method.

        The sync method must be inside a :func:`greenlet_spawn` context.
        :func:`await_only` calls cannot be nested.

        :param awaitable: The coroutine to call.

        """
        # this is called in the context greenlet while running fn
        current = getcurrent()
        if not getattr(current, "__sqlalchemy_greenlet_provider__", False):
            _safe_cancel_awaitable(awaitable)

>           raise exc.MissingGreenlet(
                "greenlet_spawn has not been called; can't call await_only() "
                "here. Was IO attempted in an unexpected place?"
            )
E           sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)

../../.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:123: MissingGreenlet
------------------------------------------------- Captured stdout call -------------------------------------------------
2025-11-14 15:51:37 [info     ] updated_workflow               policy_version_id=UUID('519fb68d-1282-4a54-be78-6886f5b0a004') project_id=ed75719d-79fd-4a39-825c-6c339d40ed61 workflow_id=a01c9087-7163-4391-9374-b693c6e46b2e
=================================================== warnings summary ===================================================
../../.venv/lib/python3.12/site-packages/testcontainers/core/waiting_utils.py:215
  /home/dev/work/fusion/lineart-plus/lineart/.venv/lib/python3.12/site-packages/testcontainers/core/waiting_utils.py:215: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

../../.venv/lib/python3.12/site-packages/testcontainers/postgres/__init__.py:90
  /home/dev/work/fusion/lineart-plus/lineart/.venv/lib/python3.12/site-packages/testcontainers/postgres/__init__.py:90: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

../../vulkan/vulkan/auth.py:24
  /home/dev/work/fusion/lineart-plus/lineart/vulkan/vulkan/auth.py:24: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AuthConfig(BaseModel):

../../vulkan/vulkan/spec/nodes/metadata.py:20
  /home/dev/work/fusion/lineart-plus/lineart/vulkan/vulkan/spec/nodes/metadata.py:20: UserWarning: Field name "schema" in "InputNodeMetadata" shadows an attribute in parent "BaseNodeMetadata"
    class InputNodeMetadata(BaseNodeMetadata):

../vulkan_engine/schemas.py:26
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:26: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Policy(PolicyBase):

../vulkan_engine/schemas.py:83
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:83: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Component(ComponentBase):

../vulkan_engine/schemas.py:117
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:117: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PolicyVersion(PolicyVersionBase):

../vulkan_engine/schemas.py:150
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:150: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Run(BaseModel):

../vulkan_engine/schemas.py:182
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:182: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StepMetadata(StepMetadataBase):

../vulkan_engine/schemas.py:196
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:196: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RunData(Run):

../vulkan_engine/schemas.py:255
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:255: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DataSourceEnvVar(DataSourceEnvVarBase):

../vulkan_engine/schemas.py:268
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DataSourceCredential(DataSourceCredentialBase):

../vulkan_engine/schemas.py:291
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/vulkan_engine/schemas.py:291: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DataObject(DataObjectMetadata):

test_integration_data_source_service.py:16
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/tests/test_integration_data_source_service.py:16: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

test_integration_policy_service.py:17
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/tests/test_integration_policy_service.py:17: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

test_integration_policy_version_service.py:19
  /home/dev/work/fusion/lineart-plus/lineart/vulkan-engine/tests/test_integration_policy_version_service.py:19: PytestUnknownMarkWarning: Unknown pytest.mark.integration - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.integration

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================================== short test summary info ================================================
FAILED test_integration_policy_version_service.py::TestPolicyVersionServiceIntegration::test_update_policy_version - sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted ...
====================================== 1 failed, 22 passed, 16 warnings in 3.58s =======================================
➜  tests git:(feat/async-vulkan-engine) ✗